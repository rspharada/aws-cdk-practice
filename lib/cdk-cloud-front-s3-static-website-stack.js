'use strict'
Object.defineProperty(exports, '__esModule', { value: true })
exports.CdkCloudFrontS3StaticWebSiteStack = void 0
const aws_cdk_lib_1 = require('aws-cdk-lib')
class CdkCloudFrontS3StaticWebSiteStack extends aws_cdk_lib_1.Stack {
	constructor(scope, id, props) {
		super(scope, id, props)
		// 1. OriginとなるS3 Bucket作成する。
		const bucketName = this.node.tryGetContext('s3').bucketName
		const websiteBucket = new aws_cdk_lib_1.aws_s3.Bucket(this, 'S3Bucket', {
			// s3バケット名を設定する。
			bucketName: bucketName,
			// Bucketへの直接アクセス禁止する。
			accessControl: aws_cdk_lib_1.aws_s3.BucketAccessControl.PRIVATE,
			// SES-3暗号化を有効にします。
			encryption: aws_cdk_lib_1.aws_s3.BucketEncryption.S3_MANAGED,
			// バブリックアクセスをブロックする。
			blockPublicAccess: aws_cdk_lib_1.aws_s3.BlockPublicAccess.BLOCK_ALL,
			// バージョニングを有効にする。
			versioned: true,
			// CDK Stack削除時にBucketも削除する。
			removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
			// 静的ウェブサイトホスティングを設定する。
			websiteIndexDocument: 'index.html',
			websiteErrorDocument: 'index.html',
		})
		// 2. Origin Access Identity作成する。
		const websiteIdentity =
			new aws_cdk_lib_1.aws_cloudfront.OriginAccessIdentity(
				this,
				'WebsiteIdentity',
				{
					comment: 'website-identity',
				},
			)
		// 3. Origin Access Identityからのアクセスのみを許可するBucket Policyを作成する。
		const webSiteBucketPolicyStatement =
			new aws_cdk_lib_1.aws_iam.PolicyStatement({
				effect: aws_cdk_lib_1.aws_iam.Effect.ALLOW,
				actions: ['s3:GetObject'],
				resources: [`${websiteBucket.bucketArn}/*`],
				principals: [
					new aws_cdk_lib_1.aws_iam.CanonicalUserPrincipal(
						websiteIdentity.cloudFrontOriginAccessIdentityS3CanonicalUserId,
					),
				],
			})
		// 4. Bucket PolicyをS3 Bucketに適用する。
		websiteBucket.addToResourcePolicy(webSiteBucketPolicyStatement)
		// 5. CloudFront Distributionを作成
		const websiteDistribution =
			new aws_cdk_lib_1.aws_cloudfront.CloudFrontWebDistribution(
				this,
				'WebsiteDistribution',
				{
					comment: 'website-distribution',
					errorConfigurations: [
						{
							errorCachingMinTtl: 300,
							errorCode: 403,
							responseCode: 200,
							responsePagePath: '/index.html',
						},
						{
							errorCachingMinTtl: 300,
							errorCode: 404,
							responseCode: 200,
							responsePagePath: '/index.html',
						},
					],
					// 6. DistributionにOrigin情報（S3 Bucket、Origin Access Identity）を設定
					originConfigs: [
						{
							s3OriginSource: {
								s3BucketSource: websiteBucket,
								originAccessIdentity: websiteIdentity,
							},
							behaviors: [
								{
									allowedMethods:
										aws_cdk_lib_1.aws_cloudfront.CloudFrontAllowedMethods
											.GET_HEAD,
									cachedMethods:
										aws_cdk_lib_1.aws_cloudfront.CloudFrontAllowedCachedMethods
											.GET_HEAD,
									isDefaultBehavior: true,
									viewerProtocolPolicy:
										aws_cdk_lib_1.aws_cloudfront.ViewerProtocolPolicy
											.REDIRECT_TO_HTTPS,
								},
							],
						},
					],
					// 料金クラス：北米、欧州、アジア、中東、アフリカを使用する
					priceClass: aws_cdk_lib_1.aws_cloudfront.PriceClass.PRICE_CLASS_200,
				},
			)
		// S3に静的ファイルをアップロードする。
		new aws_cdk_lib_1.aws_s3_deployment.BucketDeployment(
			this,
			'WebsiteDeploy',
			{
				sources: [aws_cdk_lib_1.aws_s3_deployment.Source.asset('./web/build')],
				destinationBucket: websiteBucket,
				distribution: websiteDistribution,
				distributionPaths: ['/*'],
			},
		)
	}
}
exports.CdkCloudFrontS3StaticWebSiteStack = CdkCloudFrontS3StaticWebSiteStack
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrLWNsb3VkLWZyb250LXMzLXN0YXRpYy13ZWJzaXRlLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2RrLWNsb3VkLWZyb250LXMzLXN0YXRpYy13ZWJzaXRlLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQVFvQjtBQUdwQixNQUFhLGlDQUFrQyxTQUFRLG1CQUFLO0lBQzNELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBa0I7UUFDM0QsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDdkIsNkJBQTZCO1FBQzdCLE1BQU0sVUFBVSxHQUFXLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQTtRQUNuRSxNQUFNLGFBQWEsR0FBRyxJQUFJLG9CQUFFLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUU7WUFDckQsZ0JBQWdCO1lBQ2hCLFVBQVUsRUFBRSxVQUFVO1lBQ3RCLHNCQUFzQjtZQUN0QixhQUFhLEVBQUUsb0JBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPO1lBQzdDLG1CQUFtQjtZQUNuQixVQUFVLEVBQUUsb0JBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVO1lBQzFDLG9CQUFvQjtZQUNwQixpQkFBaUIsRUFBRSxvQkFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVM7WUFDakQsaUJBQWlCO1lBQ2pCLFNBQVMsRUFBRSxJQUFJO1lBQ2YsNEJBQTRCO1lBQzVCLGFBQWEsRUFBRSwyQkFBYSxDQUFDLE9BQU87WUFDcEMsdUJBQXVCO1lBQ3ZCLG9CQUFvQixFQUFFLFlBQVk7WUFDbEMsb0JBQW9CLEVBQUUsWUFBWTtTQUNsQyxDQUFDLENBQUE7UUFDRixpQ0FBaUM7UUFDakMsTUFBTSxlQUFlLEdBQUcsSUFBSSw0QkFBVSxDQUFDLG9CQUFvQixDQUMxRCxJQUFJLEVBQ0osaUJBQWlCLEVBQ2pCO1lBQ0MsT0FBTyxFQUFFLGtCQUFrQjtTQUMzQixDQUNELENBQUE7UUFDRCw2REFBNkQ7UUFDN0QsTUFBTSw0QkFBNEIsR0FBRyxJQUFJLHFCQUFHLENBQUMsZUFBZSxDQUFDO1lBQzVELE1BQU0sRUFBRSxxQkFBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1lBQ3hCLE9BQU8sRUFBRSxDQUFDLGNBQWMsQ0FBQztZQUN6QixTQUFTLEVBQUUsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxTQUFTLElBQUksQ0FBQztZQUMzQyxVQUFVLEVBQUU7Z0JBQ1gsSUFBSSxxQkFBRyxDQUFDLHNCQUFzQixDQUM3QixlQUFlLENBQUMsK0NBQStDLENBQy9EO2FBQ0Q7U0FDRCxDQUFDLENBQUE7UUFFRixtQ0FBbUM7UUFDbkMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLDRCQUE0QixDQUFDLENBQUE7UUFFL0QsZ0NBQWdDO1FBQ2hDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSw0QkFBVSxDQUFDLHlCQUF5QixDQUNuRSxJQUFJLEVBQ0oscUJBQXFCLEVBQ3JCO1lBQ0MsT0FBTyxFQUFFLHNCQUFzQjtZQUMvQixtQkFBbUIsRUFBRTtnQkFDcEI7b0JBQ0Msa0JBQWtCLEVBQUUsR0FBRztvQkFDdkIsU0FBUyxFQUFFLEdBQUc7b0JBQ2QsWUFBWSxFQUFFLEdBQUc7b0JBQ2pCLGdCQUFnQixFQUFFLGFBQWE7aUJBQy9CO2dCQUNEO29CQUNDLGtCQUFrQixFQUFFLEdBQUc7b0JBQ3ZCLFNBQVMsRUFBRSxHQUFHO29CQUNkLFlBQVksRUFBRSxHQUFHO29CQUNqQixnQkFBZ0IsRUFBRSxhQUFhO2lCQUMvQjthQUNEO1lBQ0QsZ0VBQWdFO1lBQ2hFLGFBQWEsRUFBRTtnQkFDZDtvQkFDQyxjQUFjLEVBQUU7d0JBQ2YsY0FBYyxFQUFFLGFBQWE7d0JBQzdCLG9CQUFvQixFQUFFLGVBQWU7cUJBQ3JDO29CQUNELFNBQVMsRUFBRTt3QkFDVjs0QkFDQyxjQUFjLEVBQUUsNEJBQVUsQ0FBQyx3QkFBd0IsQ0FBQyxRQUFROzRCQUM1RCxhQUFhLEVBQ1osNEJBQVUsQ0FBQyw4QkFBOEIsQ0FBQyxRQUFROzRCQUNuRCxpQkFBaUIsRUFBRSxJQUFJOzRCQUN2QixvQkFBb0IsRUFDbkIsNEJBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxpQkFBaUI7eUJBQ2xEO3FCQUNEO2lCQUNEO2FBQ0Q7WUFDRCwrQkFBK0I7WUFDL0IsVUFBVSxFQUFFLDRCQUFVLENBQUMsVUFBVSxDQUFDLGVBQWU7U0FDakQsQ0FDRCxDQUFBO1FBRUQsc0JBQXNCO1FBQ3RCLElBQUksK0JBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsZUFBZSxFQUFFO1lBQ3hELE9BQU8sRUFBRSxDQUFDLCtCQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUNuRCxpQkFBaUIsRUFBRSxhQUFhO1lBQ2hDLFlBQVksRUFBRSxtQkFBbUI7WUFDakMsaUJBQWlCLEVBQUUsQ0FBQyxJQUFJLENBQUM7U0FDekIsQ0FBQyxDQUFBO0lBQ0gsQ0FBQztDQUNEO0FBakdELDhFQWlHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdFN0YWNrLFxuXHRTdGFja1Byb3BzLFxuXHRhd3NfczMgYXMgczMsXG5cdFJlbW92YWxQb2xpY3ksXG5cdGF3c19pYW0gYXMgaWFtLFxuXHRhd3NfY2xvdWRmcm9udCBhcyBjbG91ZGZyb250LFxuXHRhd3NfczNfZGVwbG95bWVudCBhcyBzM0RlcGxveW1lbnQsXG59IGZyb20gJ2F3cy1jZGstbGliJ1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cydcblxuZXhwb3J0IGNsYXNzIENka0Nsb3VkRnJvbnRTM1N0YXRpY1dlYlNpdGVTdGFjayBleHRlbmRzIFN0YWNrIHtcblx0Y29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFja1Byb3BzKSB7XG5cdFx0c3VwZXIoc2NvcGUsIGlkLCBwcm9wcylcblx0XHQvLyAxLiBPcmlnaW7jgajjgarjgotTMyBCdWNrZXTkvZzmiJDjgZnjgovjgIJcblx0XHRjb25zdCBidWNrZXROYW1lOiBzdHJpbmcgPSB0aGlzLm5vZGUudHJ5R2V0Q29udGV4dCgnczMnKS5idWNrZXROYW1lXG5cdFx0Y29uc3Qgd2Vic2l0ZUJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQodGhpcywgJ1MzQnVja2V0Jywge1xuXHRcdFx0Ly8gczPjg5DjgrHjg4Pjg4jlkI3jgpLoqK3lrprjgZnjgovjgIJcblx0XHRcdGJ1Y2tldE5hbWU6IGJ1Y2tldE5hbWUsXG5cdFx0XHQvLyBCdWNrZXTjgbjjga7nm7TmjqXjgqLjgq/jgrvjgrnnpoHmraLjgZnjgovjgIJcblx0XHRcdGFjY2Vzc0NvbnRyb2w6IHMzLkJ1Y2tldEFjY2Vzc0NvbnRyb2wuUFJJVkFURSxcblx0XHRcdC8vIFNFUy0z5pqX5Y+35YyW44KS5pyJ5Yq544Gr44GX44G+44GZ44CCXG5cdFx0XHRlbmNyeXB0aW9uOiBzMy5CdWNrZXRFbmNyeXB0aW9uLlMzX01BTkFHRUQsXG5cdFx0XHQvLyDjg5Djg5bjg6rjg4Pjgq/jgqLjgq/jgrvjgrnjgpLjg5bjg63jg4Pjgq/jgZnjgovjgIJcblx0XHRcdGJsb2NrUHVibGljQWNjZXNzOiBzMy5CbG9ja1B1YmxpY0FjY2Vzcy5CTE9DS19BTEwsXG5cdFx0XHQvLyDjg5Djg7zjgrjjg6fjg4vjg7PjgrDjgpLmnInlirnjgavjgZnjgovjgIJcblx0XHRcdHZlcnNpb25lZDogdHJ1ZSxcblx0XHRcdC8vIENESyBTdGFja+WJiumZpOaZguOBq0J1Y2tldOOCguWJiumZpOOBmeOCi+OAglxuXHRcdFx0cmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuXHRcdFx0Ly8g6Z2Z55qE44Km44Kn44OW44K144Kk44OI44Ob44K544OG44Kj44Oz44Kw44KS6Kit5a6a44GZ44KL44CCXG5cdFx0XHR3ZWJzaXRlSW5kZXhEb2N1bWVudDogJ2luZGV4Lmh0bWwnLFxuXHRcdFx0d2Vic2l0ZUVycm9yRG9jdW1lbnQ6ICdpbmRleC5odG1sJyxcblx0XHR9KVxuXHRcdC8vIDIuIE9yaWdpbiBBY2Nlc3MgSWRlbnRpdHnkvZzmiJDjgZnjgovjgIJcblx0XHRjb25zdCB3ZWJzaXRlSWRlbnRpdHkgPSBuZXcgY2xvdWRmcm9udC5PcmlnaW5BY2Nlc3NJZGVudGl0eShcblx0XHRcdHRoaXMsXG5cdFx0XHQnV2Vic2l0ZUlkZW50aXR5Jyxcblx0XHRcdHtcblx0XHRcdFx0Y29tbWVudDogJ3dlYnNpdGUtaWRlbnRpdHknLFxuXHRcdFx0fSxcblx0XHQpXG5cdFx0Ly8gMy4gT3JpZ2luIEFjY2VzcyBJZGVudGl0eeOBi+OCieOBruOCouOCr+OCu+OCueOBruOBv+OCkuioseWPr+OBmeOCi0J1Y2tldCBQb2xpY3njgpLkvZzmiJDjgZnjgovjgIJcblx0XHRjb25zdCB3ZWJTaXRlQnVja2V0UG9saWN5U3RhdGVtZW50ID0gbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuXHRcdFx0ZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuXHRcdFx0YWN0aW9uczogWydzMzpHZXRPYmplY3QnXSxcblx0XHRcdHJlc291cmNlczogW2Ake3dlYnNpdGVCdWNrZXQuYnVja2V0QXJufS8qYF0sXG5cdFx0XHRwcmluY2lwYWxzOiBbXG5cdFx0XHRcdG5ldyBpYW0uQ2Fub25pY2FsVXNlclByaW5jaXBhbChcblx0XHRcdFx0XHR3ZWJzaXRlSWRlbnRpdHkuY2xvdWRGcm9udE9yaWdpbkFjY2Vzc0lkZW50aXR5UzNDYW5vbmljYWxVc2VySWQsXG5cdFx0XHRcdCksXG5cdFx0XHRdLFxuXHRcdH0pXG5cblx0XHQvLyA0LiBCdWNrZXQgUG9saWN544KSUzMgQnVja2V044Gr6YGp55So44GZ44KL44CCXG5cdFx0d2Vic2l0ZUJ1Y2tldC5hZGRUb1Jlc291cmNlUG9saWN5KHdlYlNpdGVCdWNrZXRQb2xpY3lTdGF0ZW1lbnQpXG5cblx0XHQvLyA1LiBDbG91ZEZyb250IERpc3RyaWJ1dGlvbuOCkuS9nOaIkFxuXHRcdGNvbnN0IHdlYnNpdGVEaXN0cmlidXRpb24gPSBuZXcgY2xvdWRmcm9udC5DbG91ZEZyb250V2ViRGlzdHJpYnV0aW9uKFxuXHRcdFx0dGhpcyxcblx0XHRcdCdXZWJzaXRlRGlzdHJpYnV0aW9uJyxcblx0XHRcdHtcblx0XHRcdFx0Y29tbWVudDogJ3dlYnNpdGUtZGlzdHJpYnV0aW9uJyxcblx0XHRcdFx0ZXJyb3JDb25maWd1cmF0aW9uczogW1xuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGVycm9yQ2FjaGluZ01pblR0bDogMzAwLFxuXHRcdFx0XHRcdFx0ZXJyb3JDb2RlOiA0MDMsXG5cdFx0XHRcdFx0XHRyZXNwb25zZUNvZGU6IDIwMCxcblx0XHRcdFx0XHRcdHJlc3BvbnNlUGFnZVBhdGg6ICcvaW5kZXguaHRtbCcsXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRlcnJvckNhY2hpbmdNaW5UdGw6IDMwMCxcblx0XHRcdFx0XHRcdGVycm9yQ29kZTogNDA0LFxuXHRcdFx0XHRcdFx0cmVzcG9uc2VDb2RlOiAyMDAsXG5cdFx0XHRcdFx0XHRyZXNwb25zZVBhZ2VQYXRoOiAnL2luZGV4Lmh0bWwnLFxuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdF0sXG5cdFx0XHRcdC8vIDYuIERpc3RyaWJ1dGlvbuOBq09yaWdpbuaDheWgse+8iFMzIEJ1Y2tldOOAgU9yaWdpbiBBY2Nlc3MgSWRlbnRpdHnvvInjgpLoqK3lrppcblx0XHRcdFx0b3JpZ2luQ29uZmlnczogW1xuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHMzT3JpZ2luU291cmNlOiB7XG5cdFx0XHRcdFx0XHRcdHMzQnVja2V0U291cmNlOiB3ZWJzaXRlQnVja2V0LFxuXHRcdFx0XHRcdFx0XHRvcmlnaW5BY2Nlc3NJZGVudGl0eTogd2Vic2l0ZUlkZW50aXR5LFxuXHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdGJlaGF2aW9yczogW1xuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0YWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2xvdWRGcm9udEFsbG93ZWRNZXRob2RzLkdFVF9IRUFELFxuXHRcdFx0XHRcdFx0XHRcdGNhY2hlZE1ldGhvZHM6XG5cdFx0XHRcdFx0XHRcdFx0XHRjbG91ZGZyb250LkNsb3VkRnJvbnRBbGxvd2VkQ2FjaGVkTWV0aG9kcy5HRVRfSEVBRCxcblx0XHRcdFx0XHRcdFx0XHRpc0RlZmF1bHRCZWhhdmlvcjogdHJ1ZSxcblx0XHRcdFx0XHRcdFx0XHR2aWV3ZXJQcm90b2NvbFBvbGljeTpcblx0XHRcdFx0XHRcdFx0XHRcdGNsb3VkZnJvbnQuVmlld2VyUHJvdG9jb2xQb2xpY3kuUkVESVJFQ1RfVE9fSFRUUFMsXG5cdFx0XHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0XHRdLFxuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdF0sXG5cdFx0XHRcdC8vIOaWmemHkeOCr+ODqeOCue+8muWMl+exs+OAgeasp+W3nuOAgeOCouOCuOOCouOAgeS4readseOAgeOCouODleODquOCq+OCkuS9v+eUqOOBmeOCi1xuXHRcdFx0XHRwcmljZUNsYXNzOiBjbG91ZGZyb250LlByaWNlQ2xhc3MuUFJJQ0VfQ0xBU1NfMjAwLFxuXHRcdFx0fSxcblx0XHQpXG5cblx0XHQvLyBTM+OBq+mdmeeahOODleOCoeOCpOODq+OCkuOCouODg+ODl+ODreODvOODieOBmeOCi+OAglxuXHRcdG5ldyBzM0RlcGxveW1lbnQuQnVja2V0RGVwbG95bWVudCh0aGlzLCAnV2Vic2l0ZURlcGxveScsIHtcblx0XHRcdHNvdXJjZXM6IFtzM0RlcGxveW1lbnQuU291cmNlLmFzc2V0KCcuL3dlYi9idWlsZCcpXSxcblx0XHRcdGRlc3RpbmF0aW9uQnVja2V0OiB3ZWJzaXRlQnVja2V0LFxuXHRcdFx0ZGlzdHJpYnV0aW9uOiB3ZWJzaXRlRGlzdHJpYnV0aW9uLFxuXHRcdFx0ZGlzdHJpYnV0aW9uUGF0aHM6IFsnLyonXSxcblx0XHR9KVxuXHR9XG59XG4iXX0=
